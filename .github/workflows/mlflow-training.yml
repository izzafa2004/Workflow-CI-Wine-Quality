name: MLflow Model Training CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# âœ… TAMBAHKAN INI UNTUK PERMISSION RELEASES
permissions:
  contents: write

jobs:
  train-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install Dependencies
      run: |
        pip install mlflow scikit-learn pandas numpy matplotlib seaborn
        
    - name: Verify Project Structure
      run: |
        echo "Project structure:"
        ls -la
        echo "MLProject contents:"
        ls -la MLProject/
        
    - name: Train Model with MLflow
      working-directory: ./MLProject
      run: |
        echo "Training model with MLflow..."
        mlflow run . \
          -P n_estimators=200 \
          -P max_depth=15 \
          -P min_samples_split=5 \
          -P min_samples_leaf=2 \
          -P class_weight=balanced
        
    - name: Prepare Artifacts for Upload
      run: |
        echo "Preparing artifacts..."
        mkdir -p ci_artifacts
        
        # Copy any generated artifacts
        if [ -d "MLProject/ci_artifacts" ]; then
          cp -r MLProject/ci_artifacts/* ci_artifacts/ 2>/dev/null || true
        fi
        
        if [ -d "MLProject/artifacts" ]; then
          cp -r MLProject/artifacts/* ci_artifacts/ 2>/dev/null || true
        fi
        
        # Create a simple success file if no artifacts
        if [ ! "$(ls -A ci_artifacts/)" ]; then
          echo "Model training completed successfully at $(date)" > ci_artifacts/success.txt
        fi
        
        echo "Artifacts ready:"
        ls -la ci_artifacts/
        
    - name: Upload Artifacts to GitHub Actions
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts
        path: ci_artifacts/
        
    - name: Create GitHub Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Release v1.0.${{ github.run_number }}
        body: |
          Automated model training via GitHub Actions CI/CD
          
          - Run ID: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
          - Generated by: @${{ github.actor }}
          
          Artifacts included in this release.
        files: |
          ci_artifacts/*