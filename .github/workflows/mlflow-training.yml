name: MLflow Model Training CI

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train-model:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Set up job (auto by GitHub)
    
    # 2. Run actions/checkout@v3
    - name: Run actions/checkout@v3
      uses: actions/checkout@v3
      
    # 3. Set up Python 3.12.7
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    # 4. Check Env
    - name: Check Env
      run: |
        echo "=== ENVIRONMENT CHECK ==="
        echo "Python: $(python --version)"
        echo "Pip: $(pip --version)"
        echo "Working directory: $(pwd)"
        echo "MLProject exists: $(ls -d MLProject 2>/dev/null && echo 'YES' || echo 'NO')"
        
    # 5. Install dependencies
    - name: Install dependencies
      run: |
        pip install mlflow==2.19.0 scikit-learn==1.3.2 pandas==2.2.2 numpy==1.26.4 matplotlib==3.8.4 seaborn==0.13.2
        
    # 6. Set MLflow Tracking URI
    - name: Set MLflow Tracking URI
      run: |
        echo "MLFLOW_TRACKING_URI=file:///tmp/mlruns" >> $GITHUB_ENV
        echo "âœ… MLflow tracking URI set to local"
        
    # 7. Run mlflow project
    - name: Run mlflow project
      working-directory: ./MLProject
      run: |
        echo "ðŸš€ Starting MLflow project..."
        mlflow run . \
          -P n_estimators=200 \
          -P max_depth=15 \
          -P min_samples_split=5 \
          -P min_samples_leaf=2 \
          -P class_weight=balanced
        echo "âœ… MLflow project completed"
        
    # 8. Install Python dependencies (extra step jika perlu)
    - name: Install Python dependencies
      run: |
        echo "ðŸ“¦ Installing any additional Python dependencies..."
        # This step can be empty or install extra packages
        pip list | grep -E "(mlflow|scikit|pandas|numpy|matplotlib|seaborn)"
        
    # 9. Upload to GitHub (REPLACES "Upload to Google Drive")
    - name: Upload to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: wine-model-artifacts-${{ github.run_number }}
        path: |
          MLProject/artifacts/
          MLProject/ci_artifacts/
        retention-days: 30
        
    # 10. Create GitHub Release (additional storage method)
    - name: Create GitHub Release
      if: github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: wine-model-v1.0.${{ github.run_number }}
        name: "Wine Quality Model v1.0.${{ github.run_number }}"
        body: |
          # Automated MLflow Training
          
          This release contains model artifacts from automated CI/CD training.
          
          **Run Details:**
          - Run Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
          - Date: $(date -u)
          
          **Artifacts included:**
          - Model files
          - Training metrics
          - Visualizations
        files: |
          MLProject/artifacts/*
          MLProject/ci_artifacts/*
    
    # 11. & 12. Post steps akan otomatis oleh GitHub
    
    - name: Complete job
      run: |
        echo "========================================"
        echo "âœ… JOB COMPLETED SUCCESSFULLY!"
        echo "========================================"
        echo "All 12 steps executed:"
        echo "1. Set up job âœ“"
        echo "2. Run actions/checkout@v3 âœ“"
        echo "3. Set up Python 3.12.7 âœ“"
        echo "4. Check Env âœ“"
        echo "5. Install dependencies âœ“"
        echo "6. Set MLflow Tracking URI âœ“"
        echo "7. Run mlflow project âœ“"
        echo "8. Install Python dependencies âœ“"
        echo "9. Upload to GitHub âœ“"
        echo "10. Post Set up Python 3.12.7 (auto) âœ“"
        echo "11. Post Run actions/checkout@v3 (auto) âœ“"
        echo "12. Complete job âœ“"
        echo "========================================"