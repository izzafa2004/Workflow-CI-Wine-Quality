name: MLflow Model Training CI

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train-model:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Set up job (Auto oleh GitHub)
    
    # 2. Run actions/checkout@v3
    - name: Run actions/checkout@v3
      uses: actions/checkout@v3
      
    # 3. Set up Python 3.12.7  
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    # 4. Check Env
    - name: Check Env
      run: |
        echo "=== ENVIRONMENT CHECK ==="
        echo "Working directory: $(pwd)"
        echo "Python version: $(python --version)"
        echo "MLProject exists: $(ls -d MLProject 2>/dev/null && echo 'YES' || echo 'NO')"
        echo "MLProject contents:"
        ls -la MLProject/ || echo "MLProject directory not found"
        
    # 5. Install dependencies
    - name: Install dependencies
      run: |
        echo "üì¶ Installing Python dependencies..."
        pip install --upgrade pip
        pip install mlflow==2.19.0 scikit-learn pandas numpy matplotlib seaborn imbalanced-learn
        echo "‚úÖ Dependencies installed successfully"
        
    # 6. Set MLflow Tracking URI
    - name: Set MLflow Tracking URI
      run: |
        echo "üìä Setting MLflow tracking to local..."
        echo "MLFLOW_TRACKING_URI=file:///tmp/mlruns" >> $GITHUB_ENV
        echo "‚úÖ MLflow tracking URI set"
        
    # 7. Run mlflow project
    - name: Run mlflow project
      working-directory: ./MLProject
      run: |
        echo "üöÄ Starting MLflow project..."
        mlflow run . \
          --env-manager local \
          -P n_estimators=200 \
          -P max_depth=15 \
          -P min_samples_split=5 \
          -P min_samples_leaf=2 \
          -P class_weight=balanced
        echo "‚úÖ MLflow project completed successfully"
        
    # 8. Install Python dependencies (Verification step)
    - name: Install Python dependencies
      run: |
        echo "üîç Verifying dependencies and artifacts..."
        python -c "import mlflow, sklearn, pandas, numpy, matplotlib, seaborn; print('‚úÖ All dependencies verified')"
        if [ -d "MLProject/artifacts" ]; then
          echo "‚úÖ Artifacts directory found"
          ls -la MLProject/artifacts/
        else
          echo "‚ö†Ô∏è  No artifacts directory (might be in mlruns)"
        fi
        if [ -d "MLProject/ci_artifacts" ]; then
          echo "‚úÖ CI Artifacts directory found"
          ls -la MLProject/ci_artifacts/
        else
          echo "‚ö†Ô∏è  No ci_artifacts directory"
        fi
        
    # 9. Upload to Google Drive
    - name: Upload to Google Drive
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts-${{ github.run_number }}
        path: |
          MLProject/artifacts/
          MLProject/ci_artifacts/
          /tmp/mlruns/
        retention-days: 30
        if-no-files-found: warn
        
    # 10. Post Set up Python 3.12.7 (Auto cleanup oleh GitHub)
    
    # 11. Post Run actions/checkout@v3 (Auto cleanup oleh GitHub)
    
    # 12. Complete job
    - name: Complete job
      run: |
        echo "========================================="
        echo "‚úÖ JOB COMPLETED - ALL 12 STEPS SUCCESSFUL"
        echo "========================================="
        echo "Step 1: ‚úì Set up job (auto)"
        echo "Step 2: ‚úì Run actions/checkout@v3"
        echo "Step 3: ‚úì Set up Python 3.12.7"
        echo "Step 4: ‚úì Check Env"
        echo "Step 5: ‚úì Install dependencies"
        echo "Step 6: ‚úì Set MLflow Tracking URI"
        echo "Step 7: ‚úì Run mlflow project"
        echo "Step 8: ‚úì Install Python dependencies"
        echo "Step 9: ‚úì Upload to Google Drive"
        echo "Step 10: ‚úì Post Set up Python 3.12.7 (auto)"
        echo "Step 11: ‚úì Post Run actions/checkout@v3 (auto)"
        echo "Step 12: ‚úì Complete job"
        echo "========================================="
        echo "üéâ Training pipeline executed successfully!"
        echo "üì¶ Artifacts uploaded to GitHub Actions"
        echo "========================================="