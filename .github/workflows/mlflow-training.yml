name: MLflow Model Training CI

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train-model:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Set up job (Auto oleh GitHub)
    
    # 2. Checkout code
    - name: Run actions/checkout@v3
      uses: actions/checkout@v3
      
    # 3. Set up Python 3.12.7  
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    # 4. Check Environment
    - name: Check Env
      run: |
        echo "=== ENVIRONMENT CHECK ==="
        echo "Working directory: $(pwd)"
        echo "Python version: $(python --version)"
        echo "MLProject exists: $(ls -d MLProject 2>/dev/null && echo 'YES' || echo 'NO')"
        echo "MLProject contents:"
        ls -la MLProject/ || echo "MLProject directory not found"
        
    # 5. Install dependencies
    - name: Install dependencies
      run: |
        echo "üì¶ Installing Python dependencies..."
        pip install --upgrade pip
        pip install mlflow==2.19.0 scikit-learn pandas numpy matplotlib seaborn imbalanced-learn
        echo "‚úÖ Dependencies installed successfully"
        
    # 6. Set MLflow Tracking URI
    - name: Set MLflow Tracking URI
      run: |
        echo "üìä Setting MLflow tracking to local..."
        echo "MLFLOW_TRACKING_URI=file:///tmp/mlruns" >> $GITHUB_ENV
        echo "‚úÖ MLflow tracking URI set"
        
    # 7. Run MLflow project
    - name: Run mlflow project
      working-directory: ./MLProject
      run: |
        echo "üöÄ Starting MLflow project..."
        mlflow run . \
          --env-manager local \
          -P n_estimators=200 \
          -P max_depth=15 \
          -P min_samples_split=5 \
          -P min_samples_leaf=2 \
          -P class_weight=balanced
        echo "‚úÖ MLflow project completed successfully"
        
    # 8. Verify training artifacts
    - name: Install Python dependencies
      run: |
        echo "üîç Verifying dependencies and artifacts..."
        python -c "import mlflow, sklearn, pandas, numpy, matplotlib, seaborn; print('‚úÖ All dependencies verified')"
        if [ -d "MLProject/artifacts" ]; then
          echo "‚úÖ Artifacts directory found"
          ls -la MLProject/artifacts/
        else
          echo "‚ö†Ô∏è  No artifacts directory (might be in mlruns)"
        fi
        
    # 9. Upload to GitHub Artifacts
    - name: Upload to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts-${{ github.run_number }}
        path: |
          MLProject/artifacts/
          MLProject/ci_artifacts/
          /tmp/mlruns/
        retention-days: 30
        if-no-files-found: warn
        
    # 10. Post Set up Python (Auto cleanup oleh GitHub)
    
    # 11. Post Run actions/checkout (Auto cleanup oleh GitHub)
    
    # 12. Complete job
    - name: Complete job
      run: |
        echo "========================================="
        echo "‚úÖ JOB COMPLETED - ALL STEPS SUCCESSFUL"
        echo "========================================="
        echo "‚úì Step 1: Set up job (auto)"
        echo "‚úì Step 2: Checkout code"
        echo "‚úì Step 3: Set up Python 3.12.7"
        echo "‚úì Step 4: Check environment"
        echo "‚úì Step 5: Install dependencies"
        echo "‚úì Step 6: Set MLflow tracking URI"
        echo "‚úì Step 7: Run MLflow project"
        echo "‚úì Step 8: Verify artifacts"
        echo "‚úì Step 9: Upload to GitHub"
        echo "‚úì Step 10: Post cleanup (auto)"
        echo "‚úì Step 11: Post cleanup (auto)"
        echo "‚úì Step 12: Complete job"
        echo "========================================="
        echo "üéâ Training pipeline executed successfully!"
        echo "========================================="